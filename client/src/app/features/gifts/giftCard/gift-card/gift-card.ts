import { Component, EventEmitter, Input, input, Output } from '@angular/core';
import { CartItemQty } from '../cart-item-qty/cart-item-qty';
import { AdminOptions } from '../admin-options/admin-options';
import { GiftResponseDto } from '../../../../core/models/gift-model';
import { CardModule } from 'primeng/card';
import { CartService } from '../../../../core/services/cart-service';
import { GiftsService } from '../../../../core/services/gifts-service';
import { ButtonModule } from 'primeng/button';
import { AuthService } from '../../../../core/services/auth-service';
import { Router } from '@angular/router';
import { NotificationService } from '../../../../core/services/notification-service';

@Component({
  selector: 'app-gift-card',
  imports: [CartItemQty, CardModule, ButtonModule],
  templateUrl: './gift-card.html',
  styleUrl: './gift-card.scss',
})
export class GiftCard {
  constructor(private cartService: CartService, private giftsService: GiftsService, private authService: AuthService, private router: Router, private notificationService: NotificationService ) { }

  @Input() gift!: GiftResponseDto;
  // @Input() count!: number;
  @Input() isAdmin: boolean = false;
  @Input() purchaseId: number | null = null;
  @Input() qty: number=0;


  @Output() render = new EventEmitter<boolean>();
  @Output() edit = new EventEmitter<GiftResponseDto>();



  onCountChange(count: number) {
    if (!this.gift?.id) return;


    this.authService.getCurrentUserId().subscribe(userId => {
      console.log("userId", userId);
      if (!userId) { this.notificationService.showError('User not logged in'); this.router.navigate(['/login']); return; }
      console.log('purchaseID', this.purchaseId);

      if (count === 0 && this.purchaseId) {
        this.cartService.remove(this.purchaseId).subscribe();
        return;
      }

      this.cartService.updateQty({
        userId,
        giftId: this.gift.id,
        qty: count
      }).subscribe();
    });
  }

  onDelete() {
    console.log("onDelete!");
this.notificationService.confirmDelete(() => {
    this.giftsService.delete(this.gift.id).subscribe({
      next: gift => {
        this.notificationService.showSuccess('Gift deleted successfully!');
        this.render.emit(true);
      },
      error: (err) => {
        console.error('Delete gift failed', err);

        const message =
          err?.error?.detail ||
          err?.error?.message ||
          'Unauthorized or unexpected error';

        this.notificationService.showError('Delete gift failed: ' + message);
      }
    });
  });
  }

  onEdit() {
    this.edit.emit(this.gift);
  }

  get imageSrc(): string {

    return this.gift.imageUrl
      ? `http://localhost:5071${this.gift.imageUrl}`
      : 'http://localhost:5071/uploads/gifts/placeholder.jpg';
  }
}
